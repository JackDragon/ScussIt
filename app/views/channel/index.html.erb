<!-- Javascript -->
<script type="text/javascript">

$(document).ready(function (){
  // alert(1)
  id = <%= @channel.id %>
  get_messages(id);
});

function get_messages(cid) {

  console.log("/channel/" + cid + "/messages");
  data = $.ajax({
    dataType: "json",
    type: "GET",
    // channel_id should be dynamic
    url: "/channel/" + cid + "/messages",
    async: false
  }).success(function(data){      
  }).responseText;

  data = JSON.parse(data)
  total = ""
  for (var i = 0; i < data['messages'].length; i++) {
      
      message = data['messages'][i]
      username = message['userID']
      body = "<p>"+message['body']+"</p>"
      total+=body
      
  };
  $('#chatbox').html(total);
  // setTimeout(function(){get_messages(cid);}, 720); 
}

function post_message(cid,message){

   $.ajax({
    url: '/channel/'+cid+'/post',
    type: 'POST',
    data: {'channel_id': 'cid', 'body': 'message'},
  })
  .done(function() {
    console.log("success");
  })
  .fail(function() {
    console.log("error");
  })
  .always(function() {
    console.log("complete");
  });
}
function click_send(){
  alert("hi")
  message = $("#message_input").val()
  post_message(id, message)
}


</script>

<!-- HTML -->
<table>
  <div>MESSAGES:</div>
  <p id="chatbox">
    <% @messages.each do |message| %>
        <tr>
          <% if message.user %>
              <td><%= message.user.username %>: </td><td><%= message.body %></td>
          <% else %>
              <td>Anon:</td><td><%= message.body %></td>
          <% end %>
        </tr>
    <% end %>
  </p>
</table>
<div>---</div>
<input id="message_input"></input> 
<button onclick="click_send()">send</button>

<% if !current_user.nil? %>
  <% if !current_user.favorites.exists?(:channel_id => @channel.id) %>
    <%= button_to "Follow", {:controller => "channel", :action => "follow", :cid => @channel.id }  %>
  <% else %>
    <%= button_to "Unfollow", {:controller => "channel", :action => "unfollow", :cid => @channel.id } %>
  <% end %>
<% end %>


